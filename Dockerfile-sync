# LandPPT Docker Image
# Multi-stage build for minimal image size

# ==========================================
# Build stage
# ==========================================
FROM python:3.11-slim-bookworm AS builder

# Set environment variables for build
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    UV_PROJECT_ENVIRONMENT=/opt/venv \
    PLAYWRIGHT_BROWSERS_PATH=/opt/playwright-browsers \
    PLAYWRIGHT_SKIP_VALIDATE_HOST_REQUIREMENTS=1

# Install build dependencies
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    build-essential \
    ca-certificates \
    curl \
    git \
    libatomic1 \
    && rm -rf /var/lib/apt/lists/*

# Install uv for faster dependency management
RUN pip install --no-cache-dir uv

# Set work directory and copy dependency files
WORKDIR /app
COPY pyproject.toml uv.lock* uv.toml README.md ./
COPY src/ ./src/

# Install Python dependencies using uv
# 【关键】在这里安装 webdavclient3 和 requests，确保它们进入虚拟环境
RUN uv sync --frozen --no-dev --extra-index-url=https://pypi.apryse.com && \
    uv pip install webdavclient3 requests && \
    # Verify key packages are installed
    /opt/venv/bin/python -c "import uvicorn; import playwright; import fastapi; import webdav3" && \
    # Clean up build artifacts
    find /opt/venv -name "*.pyc" -delete && \
    find /opt/venv -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true

# Install Playwright browsers in builder stage
RUN set -eux; \
    mkdir -p /opt/playwright-browsers; \
    /opt/venv/bin/python -c "from importlib.metadata import version; print('Playwright version:', version('playwright'))"; \
    export DEBUG=pw:install; \
    for i in 1 2 3; do \
      /opt/venv/bin/python -m playwright install chromium && exit 0; \
      echo "Playwright Chromium install failed (attempt $i)" >&2; \
      sleep 5; \
    done; \
    echo "Retrying Playwright download with mirror (npmmirror.com)..." >&2; \
    PLAYWRIGHT_DOWNLOAD_HOST=https://npmmirror.com/mirrors/playwright /opt/venv/bin/python -m playwright install chromium

# ==========================================
# Production stage
# ==========================================
FROM python:3.11-slim-bookworm AS production
ARG TARGETARCH

# Set environment variables
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONPATH=/app/src:/opt/venv/lib/python3.11/site-packages \
    PATH=/opt/venv/bin:$PATH \
    PLAYWRIGHT_BROWSERS_PATH=/opt/playwright-browsers \
    HOME=/root \
    VIRTUAL_ENV=/opt/venv

# Install essential runtime dependencies and wkhtmltopdf
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    awscli \
    coreutils \
    curl \
    wget \
    poppler-utils \
    libmagic1 \
    ca-certificates \
    libgomp1 \
    libatomic1 \
    fonts-liberation \
    fonts-noto-cjk \
    fontconfig \
    netcat-openbsd \
    xfonts-75dpi \
    xfonts-base \
    libjpeg62-turbo \
    libxrender1 \
    libfontconfig1 \
    libx11-6 \
    libxext6 \
    libnss3 \
    libatk1.0-0 \
    libatk-bridge2.0-0 \
    libcups2 \
    libdrm2 \
    libxkbcommon0 \
    libxcomposite1 \
    libxdamage1 \
    libxfixes3 \
    libxrandr2 \
    libgbm1 \
    libasound2 \
    libpango-1.0-0 \
    libcairo2 \
    && \
    WKHTMLTOPDF_VERSION="0.12.6.1-3" && \
    WKHTML_ARCH="${TARGETARCH:-$(dpkg --print-architecture)}" && \
    case "$WKHTML_ARCH" in amd64|arm64) ;; *) echo "Unsupported wkhtmltopdf arch: $WKHTML_ARCH" >&2; exit 1 ;; esac && \
    wget -q "https://github.com/wkhtmltopdf/packaging/releases/download/${WKHTMLTOPDF_VERSION}/wkhtmltox_${WKHTMLTOPDF_VERSION}.bookworm_${WKHTML_ARCH}.deb" -O /tmp/wkhtmltox.deb && \
    dpkg -i /tmp/wkhtmltox.deb || apt-get install -f -y && \
    rm /tmp/wkhtmltox.deb && \
    fc-cache -fv && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* /root/.cache

# Create non-root user
RUN groupadd -r landppt && \
    useradd -r -g landppt -m -d /home/landppt landppt

# Copy Python packages from builder
COPY --from=builder /opt/venv /opt/venv
# Copy Playwright browsers from builder
COPY --from=builder /opt/playwright-browsers /opt/playwright-browsers

# Create symlink for python3 just in case
RUN ln -sf /opt/venv/bin/python /opt/venv/bin/python3

# Set permissions
RUN chown -R landppt:landppt /home/landppt && \
    chmod -R 755 /opt/playwright-browsers

# Set work directory
WORKDIR /app

# Copy application code
COPY run.py ./
COPY src/ ./src/
COPY template_examples/ ./template_examples/
COPY docker-healthcheck.sh docker-entrypoint.sh ./
COPY .env.example ./.env
COPY sync_data.sh /app/sync_data.sh

# Create directories, set permissions, and inject sync script
# 【关键】sed -i 's/\r$//' /app/sync_data.sh 用于修复 Windows 换行符导致的 EOF 报错
RUN sed -i 's/\r$//' /app/sync_data.sh && \
    chmod +x docker-healthcheck.sh docker-entrypoint.sh /app/sync_data.sh && \
    mkdir -p temp/ai_responses_cache temp/style_genes_cache temp/summeryanyfile_cache temp/templates_cache \
             research_reports lib/Linux lib/MacOS lib/Windows uploads data && \
    chown -R landppt:landppt /app /home/landppt && \
    chmod -R 755 /app /home/landppt && \
    chmod 666 /app/.env && \
    # 注入 sync_data.sh 到 entrypoint
    sed -i '/exec "$@"/i /app/sync_data.sh' /app/docker-entrypoint.sh

# Expose port
EXPOSE 8000

# Minimal health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=2 \
    CMD ./docker-healthcheck.sh

# Set entrypoint and command
ENTRYPOINT ["./docker-entrypoint.sh"]
CMD ["python", "run.py"]
